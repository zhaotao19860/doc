# 拓扑结构(NAT)

原理图：

![nat.png](image/kvm/nat.png)

# **制作镜像(NAT)**

## 准备基础ISO镜像

-   官方[CentOS-7-x86_64-Minimal-1511.iso](https://buildlogs.centos.org/rolling/7/isos/x86_64/CentOS-7-x86_64-Minimal-1511.iso)
    (centos7.2)

| mkdir -p /export/servers && cd /export/servers <br/> git lfs clone --depth=1 <https://git.jd.com/dns-anti/dns-vm.git> <br/> git lfs pull <br/> mkdir -p /export/images/ <br/> cp /export/servers/dns-vm/adns/images/CentOS-7-x86_64-Minimal-1511.iso /export/images/ <br\> |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 先决条件

-   cpu支持：egrep -q "vmx\|svm" /proc/cpuinfo && echo "yes"

-   内存支持：free -h (大于64g)

-   内核支持：lsmod \|grep kvm

-   Selinux支持：setenforce 0 && sestatus

-   大页内存支持：cat /proc/cpuinfo \| grep pdpe1gb

-   支持转发：sysctl -w net.ipv4.ip_forward=1

-   物理机有外网访问权限

## 准备大页内存

| sh /export/servers/dns-vm/adns/tools/install_hugepages.sh //配置大页内存  <br/> reboot //重启服务器  <br/> cat /proc/meminfo\|grep Huge //检查大页内存是否生效 |
|--------------------------------------------------------------------------------------------------------------------------------------------------|


## 安装依赖

-   安装

| yum -y install qemu-kvm virt-install libvirt bridge-utils systemctl enable libvirtd && systemctl start libvirtd |
|-----------------------------------------------------------------------------------------------------------------|


-   检查

| 1./usr/sbin/libvirtd --version <br/> /usr/sbin/libvirtd (libvirt) 4.5.0 <br/> 2./usr/libexec/qemu-kvm --version <br/> QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-167.el7_7.4), Copyright (c) 2003-2008 Fabrice Bellard <br/> 注意： 报错：version libssl.so.10 not defined in file libssl.so.10 <br/> 修复：yum -y install openssl && yum -y update openssl <br/> 3.uname -r(大于等于2.6.20，自动包含kvm内核模块) 3.10.0-327.28.3.el7.x86_64 <br/> 4.virsh list --all |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 制作镜像

### 安装系统

>   virt-install \\

\--name adns-vm \\(虚拟机名称)

\--vcpus=8 \\(虚拟机cpu个数)

\--memory 32768 \\(虚拟机内存大小，单位MB，32G)

\--disk /export/images/adns-vm.qcow2,size=100,format=qcow2
\\(存储磁盘格式及大小，单位GB, 100G)

\--network default \\(虚拟机网卡：默认为nat模式，网桥模式：--network bridge:br0)

\--os-type=linux \\(虚拟机操作系统类型)

\--os-variant=rhel7.2 \\(虚拟机操作系统具体版本)

\--location /export/images/CentOS-7-x86_64-Minimal-1511.iso \\(安装源地址)

\--extra-args "console=ttyS0" \\(虚拟机登录字符终端)

\--graphics none \\(虚拟机不开启图形登录界面)

\--force(防止交互式提示)

| cd /export/images/ virt-install \ <br/>  --name adns-vm \ <br/>  --vcpus=8 \ <br/>  --memory 32768 \ <br/>  --disk /export/images/adns-vm.qcow2,size=100,format=qcow2 \ <br/>  --network default \ <br/>  --os-type=linux \ <br/>  --os-variant=rhel7.2 \ <br/>  --location /export/images/CentOS-7-x86_64-Minimal-1511.iso \ <br/>  --extra-args "console=ttyS0" \ <br/>  --graphics none \ <br/>  --force |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


### 配置系统

上面创建虚拟机命令最终需要你配置系统基础设置，带 [!]
基本都是要配置的，按照顺序往下配置，按对用的数字以此进行设置。

| Installation  <br/>  1) [x] Language settings 2) [!] Timezone settings  <br/>  (English (United States)) (Timezone is not set.)(Shanghai)  <br/>  3) [!] Installation source 4) [!] Software selection  <br/>  (Processing...)(local) (Processing...)(minimal)  <br/>  5) [!] Installation Destination 6) [x] Kdump  <br/>  (No disks selected)(all) (Kdump is enabled)  <br/>  7) [ ] Network configuration 8) [!] Root password  <br/>  (Not connected) (Password is not set.)  <br/>  9) [!] User creation  (No user will be created)  <br/>  Please make your choice from above ['q' to quit | 'b' to begin installation |  'r' to refresh]:  <br/> 设置2(asia-shanghai),4(默认),5(全部默认),8(adns), b(开始安装) |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 编辑镜像

### 设置网络

>   ipv4地址配置：

| 虚拟机： <br/>  virsh console adns-vm //登录虚拟机 <br/>  vi /etc/sysconfig/network-scripts/ifcfg-eth0 //网卡改为自启动  <br/> TYPE=Ethernet BOOTPROTO=dhcp <br/>  …  <br/> NAME=eth0  <br/> UUID=c4437b5b-cdda-4a6e-a9ed-61241ad38fdc  <br/> DEVICE=eth0  <br/> ONBOOT=yes |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


Ctrl+] //退出虚拟机

>   ipv6地址配置：

| 物理机：  <br/> virsh shutdown adns-vm  <br/> virsh net-destroy default  <br/> virsh net-edit default  <br/> \<network\>   <br/> \<name\>default\</name\>   <br/> \<uuid\>869052a8-a707-43a5-b16a-bca137e1432f\</uuid\>   <br/> \<forward mode='nat'/\>  <br/>  \<bridge name='virbr0' stp='off' delay='0'/\>  <br/>  \<mac address='52:54:00:f9:c1:76'/\>  <br/>  \<ip address='192.168.122.1' netmask='255.255.255.0'\>  <br/>  \<dhcp\>  <br/>  \<range start='192.168.122.2' end='192.168.122.254'/\>  <br/>  \</dhcp\>  <br/>  \</ip\>  <br/>  \<ip family='ipv6' address='2001:db8:dead:beef:fe::2' prefix='96'/\> <br/>  \</network\> |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


virsh net-start default

virsh start adns-vm

虚拟机：

virsh console adns-vm

vi /etc/sysconfig/network-scripts/ifcfg-eth0

| TYPE=Ethernet  <br/> BOOTPROTO=dhcp  <br/> DEFROUTE=yes  <br/> PEERDNS=yes  <br/> PEERROUTES=yes  <br/> IPV4_FAILURE_FATAL=no  <br/> IPV6INIT=yes  <br/> IPV6_AUTOCONF=no  <br/> IPV6ADDR=2001:db8:dead:beef:fe::8001/96  <br/> IPV6DEFAULTGW=fe80::5054:ff:fef9:c176/64  <br/> NAME=eth0  <br/> UUID=c4437b5b-cdda-4a6e-a9ed-61241ad38fdc  <br/> DEVICE=eth0  <br/> ONBOOT=yes |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


systemctl restart network

ping6 2001:db8:dead:beef:fe::2

Ctrl+] //退出虚拟机

### 设置cpu/内存/网卡

虚拟机：

| virsh edit adns-vm //编辑虚拟机配置文件  <br/> //使用物理机配置的大页内存，开启网卡多队列  <br/> \<domain type='kvm' id='3'\>   <br/> \<name\>adns-vm\</name\>   <br/> \<uuid\>ff91ffdf-3820-40d0-badd-b66773173b5e\</uuid\>   <br/> \<memory unit='G'\>64\</memory\>  <br/> \<currentMemory unit='G'\>64\</currentMemory\>  <br/> \<memoryBacking\>  <br/> \<hugepages\>  <br/> \<page size='1' unit='G' /\>  <br/> \</hugepages\>   <br/> \</memoryBacking\>   <br/> \<vcpu placement='static'\>8\</vcpu\>   <br/> \<cputune\>  <br/> \<vcpupin vcpu='0' cpuset='0' /\>  <br/> \<vcpupin vcpu='1' cpuset='2' /\>  <br/> \<vcpupin vcpu='2' cpuset='4' /\>  <br/> \<vcpupin vcpu='3' cpuset='6' /\>  <br/> \<vcpupin vcpu='4' cpuset='8' /\>  <br/> \<vcpupin vcpu='5' cpuset='10' /\>  <br/> \<vcpupin vcpu='6' cpuset='12' /\>  <br/> \<vcpupin vcpu='7' cpuset='14' /\>   <br/> \</cputune\>   <br/> …   <br/> \<cpu mode='custom' match='exact' check='full'\>  <br/> \<model fallback='forbid'\>Haswell\</model\>  <br/> \<feature policy='force' name='pdpe1gb'/\>   <br/> \<feature policy='disable' name='hle'/\>   <br/> \<feature policy='disable' name='rtm'/\>   <br/> \<feature policy='require' name='hypervisor'/\>   <br/> \<feature policy='require' name='xsaveopt'/\>   <br/> \</cpu\>  <br/>  … <br/>  \<interface type='network'\>  <br/> \<source network='default'/\>  <br/> \<model type='virtio'/\>  <br/> \<driver name='vhost' queues='8'/\>  <br/> \<address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/\> <br/>  \</interface\>  <br/> … <br/>  \</domain\> |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


virsh start adns-vm//开启虚拟机

virsh console adns-vm//登录虚拟机

| sed -i '/GRUB_CMDLINE_LINUX/ s/"\$/ default_hugepagesz=1G hugepagesz=1G hugepages=32"/' /etc/default/grub //修改虚拟机grub  <br/> grub2-mkconfig -o /boot/grub2/grub.cfg //重新生成grub  <br/> sed -i 's/=enforcing/=disabled/' /etc/selinux/config \#关闭selinux,重启生效  <br/> systemctl disable NetworkManager  <br/> reboot |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


cat /proc/meminfo \|grep Huge //验证

## 安装adns

| ssh root\@vm-ip mkdir -p /export/servers/  <br/> 安装基础环境  <br/> yum -y install git yum -y group install "Development Tools"  <br/> 安装go编译环境(用于dns-agent编译)  <br/> rpm --import https://mirror.go-repo.io/centos/RPM-GPG-KEY-GO-REPO  <br/> curl -s https://mirror.go-repo.io/centos/go-repo.repo \| tee /etc/yum.repos.d/go-repo.repo  <br/> yum -y install golang  <br/> 安装adns依赖(git/redis/keepalived)  <br/> cd /export/servers/  <br/> git clone --depth=1 <https://git.jd.com/dns-anti/adns-docker.git>  <br/> cd /export/servers/adns-docker/git-upgrade && sh ./run.sh upgrade //升级git版本  <br/> cd /export/servers/adns-docker/  <br/> 如果已执行可跳过：sh install_hugepages_1g.sh 或者 sh install_hugepages_2m.sh //设置大页内存  <br/> python docker/dependent-lib/dpdk/dpdk-stable-16.11.2/tools/dpdk-devbind.py --status //获取网卡的编号  <br/> sh install.sh [设备的pci地址] //安装依赖(pci地址可通过install.sh不加参数获取)  <br/> 安装adns  <br/> cd /export/servers/  <br/> git clone --depth=1 <http://git.jd.com/dns-anti/TPDNS.git> adns  <br/> cd /export/servers/adns  <br/> sh build.sh   <br/> 安装dns-agent(可选，用于流量统计)  <br/> cd /export/servers/  <br/> git clone --depth=1 https://git.jd.com/dns-anti/dns-agent.git   <br/> cd /export/servers/dns-agent  <br/> sh build.sh   <br/> 修改网卡启动模式 //网卡改为非自启动，因为dpdk不能操作已经启动的网卡  <br/> vi /etc/sysconfig/network-scripts/ifcfg-eth0   <br/> TYPE=Ethernet  <br/> BOOTPROTO=dhcp  <br/> …  <br/> NAME=eth0  <br/> UUID=c4437b5b-cdda-4a6e-a9ed-61241ad38fdc  <br/> DEVICE=eth0  <br/> ONBOOT=no |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 配置adns

### adns

| vi /export/servers/adns/output/etc/adns.conf(红色部分按需修改)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 配置太长 --- 参见docx文档 |

### conf-pull

| vi /export/servers/adns/output/etc/conf-pull.conf(红色部分按需修改)                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 配置太长 --- 参见docx文档 |
| 设置conf-pull.py免密登录git服务器： <br/>  ssh-keygen -t rsa (连续三次回车,即在本地生成了公钥和私钥,不设置密码) <br/>  ssh-copy-id -i \~/.ssh/id_rsa.pub 用户名\@git-ip                                                                                                                                                                                                                                                                                                                                                                                |

### dns-agent

| vi /export/servers/dns-agent/output/conf/config.json(红色部分按需修改)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 配置太长 --- 参见docx文档 |

### keepalived

>   虚拟机：

| vi /export/servers/keepalived-1.3.5/etc/keepalived.conf(红色部分按需修改)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 配置太长 --- 参见docx文档 |

## 启动adns

| vi /etc/rc.local //设置服务随系统自启动(keepalived除外)  <br/> \#!/bin/bash  <br/> \# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES  <br/> \# \# It is highly advisable to create own systemd services or udev rules  <br/> \# to run scripts during boot instead of using this file.  <br/> \# \# In contrast to previous versions due to parallel execution during boot  <br/> \# this script will NOT be run after all other services.  <br/> \# \# Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure  <br/> \# that this script will be executed during boot.  <br/> touch /var/lock/subsys/local  <br/> sh /export/servers/dns-agent/output/bin/control start  <br/> sh /export/servers/adns-docker/install.sh 0000:00:03.0 |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


python /export/servers/adns/output/bin/conf-pull.py //第一次启动前需要有配置存在

ip link set eth0 down //停止网卡用于绑定

sh /export/servers/adns-docker/install.sh [设备的pci地址] //绑定网卡

sh /export/servers/dns-agent/output/bin/control restart //重启dns-agent

systemctl restart redis //重启redis

sh /export/servers/adns/output/bin/control restart //重启adns

systemctl restart keepalived //重启keepalived

ip route add default via 192.168.122.1 dev vEth0 //增加默认路由

ip -6 route add default via 2001:db8:dead:beef:fe::2 dev vEth0 //增加默认路由

## 测试adns

>   物理机：

| dig \@vm-ipv4  <br/> dig \@vm-ipv6  <br/> dig \@keepalived-vip  <br/> ping vm-ipv4  <br/> ping vm-ipv6  <br/> ping keepalived-vip |
|------------------------------------------------------------------------------------------------|


## 清理虚拟机

>   虚拟机：

| virsh console adns-vm  <br/> sh /export/servers/adns/output/bin/control stop //停止adns  <br/> 软件清理：  <br/> mv /export/servers/adns-docker /export/servers/adns-docker.bak  <br/> mkdir -p /export/servers/adns-docker && cp /export/servers/adns-docker.bak/install.sh /export/servers/adns-docker  <br/> \\rm -rf /export/servers/adns-docker.bak  <br/> mv /export/servers/adns /export/servers/adns.bak  <br/> mkdir -p /export/servers/adns && cp -r /export/servers/adns.bak/output /export/servers/adns/  <br/> \\rm -rf /export/servers/adns.bak   <br/> \\rm -rf /export/servers/adns/output/etc/\*.map  <br/> \\rm -rf /export/tp-dns/log  <br/> \\rm -rf /export/tp-dns/git-merge  <br/> \\rm -rf /export/tp-dns/git-local  <br/> \\rm -rf /export/tp-dns/etc  <br/> \\rm -rf /export/tp-dns/dump  <br/> \\rm -rf /export/tp-dns/adns-conf/views/\*  <br/> \\rm -rf /export/tp-dns/adns-conf/zones/\*  <br/> \\rm -rf /export/servers/adns/log  <br/> yum清理：  <br/> yum clean all  <br/> 历史记录清理：  <br/> echo "" \> \~/.bash_history && history -c  <br/> 清理已删除空间：  <br/> dd if=/dev/zero of=/zero.dat //虚拟机系统对剩余空间写零操作  <br/> \\rm -rf /zero.dat //删除零文件 |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 压缩备份镜像

>   物理机：

| virsh attach-disk --type cdrom --mode readonly adns-vm "" hda //卸载ISO  <br/> virsh shutdown adns-vm //关闭虚拟机  <br/> virsh dumpxml adns-vm \> /export/images/adns-vm-release-20200723.xml //导出虚拟机配置  <br/> //压缩虚拟机镜像 qemu-img convert -c -O qcow2 /export/images/adns-vm.qcow2 /export/images/adns-vm-release-20200723.qcow2  <br/> //修改新虚拟机配置中镜像路径  <br/> vi /export/images/adns-vm-release-20200723.xml  <br/> \<domain type='kvm'\>   <br/> \<name\>adns-vm\</name\>   <br/> \<uuid\>51b1f6d9-8f90-4c40-bbc8-38146e81a7c3\</uuid\>   <br/> …   <br/> \<devices\>   <br/> \<emulator\>/usr/libexec/qemu-kvm\</emulator\>   <br/> \<disk type='file' device='disk'\>   <br/> \<driver name='qemu' type='qcow2'/\>   <br/> \<source file='/export/images/adns-vm-release-20200723.qcow2'/\>   <br/> \<target dev='vda' bus='virtio'/\>   <br/> \<address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/\>  <br/> \</disk\>  <br/> \</devices\>  <br/> \</domain\> |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 虚拟机相关命令

>   物理机：

| 列出虚拟机：virsh list  <br/> 强制停止虚拟机：virsh destroy adns-vm (相当于物理机的直接关闭电源)  <br/> 正常停止虚拟机：virsh shutdown adns-vm  <br/> 删除虚拟机：virsh undefine adns-vm  <br/> 查找并删除虚拟机相关文件：updatedb && locate adns-vm && rm –rf 找到的文件  <br/> 重启虚拟机：virsh reboot adns-vm  <br/> 查看虚拟机配置：virsh dumpxml adns-vm  <br/> 编辑虚拟机配置：virsh destroy adns-vm && virsh edit adns-vm  <br/> 登录虚拟机：ssh root\@ip  <br/> 登录虚拟机：virsh console adns-vm  <br/> 退出虚拟机：Ctrl + ]  <br/> 添加网卡： virsh attach-interface  <br/> \\ --domain adns-vm  <br/> \\ --type network  <br/> \\ --source default  <br/> \\ --model virtio  <br/> \\ --config  <br/> \\ --live  <br/> 删除网卡： virsh detach-interface  <br/> \\ --domain adns-vm  <br/> \\ --type network  <br/> \\ --mac 52:54:00:1a:3e:91  <br/> \\ --config |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


# 拓扑结构(网桥)

原理图：

![vhost.png](image/kvm/bridge.png)

# **部署镜像(网桥)**

## 先决条件

-   cpu支持：egrep -q "vmx\|svm" /proc/cpuinfo && echo "yes"

-   内存支持：free -h (大于64g)

-   内核支持：lsmod \|grep kvm

-   Selinux支持：setenforce 0 && sestatus

-   大页内存支持：cat /proc/cpuinfo \| grep pdpe1gb

-   支持转发：sysctl -w net.ipv4.ip_forward=1

## 安装依赖

-   安装

| yum -y install qemu-kvm virt-install libvirt bridge-utils  <br/> systemctl enable libvirtd && systemctl start libvirtd |
|-----------------------------------------------------------------------------------------------------------------|


-   检查

| 1./usr/sbin/libvirtd --version  <br/> /usr/sbin/libvirtd (libvirt) 4.5.0  <br/> 2./usr/libexec/qemu-kvm --version  <br/> QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-167.el7_7.4), Copyright (c) 2003-2008 Fabrice Bellard  <br/> 注意：  <br/> 报错：version libssl.so.10 not defined in file libssl.so.10  <br/> 修复：yum -y install openssl && yum -y update openssl  <br/> 3.uname -r(大于等于2.6.20，自动包含kvm内核模块) 3.10.0-327.28.3.el7.x86_64  <br/> 4.virsh list --all |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 设置网桥

### 管理口网桥

| 增加网桥：  <br/> vi /etc/sysconfig/network-scripts/ifcfg-br-manager //创建网桥(ip及路由来自eth0)  <br/> DEVICE=br-manager  <br/> TYPE=Bridge  <br/> BOOTPROTO=static  <br/> IPADDR=10.226.133.67  <br/> NETMASK=255.255.255.224  <br/> GATEWAY=10.226.133.97  <br/> ONBOOT=yes |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


vi /etc/sysconfig/network-scripts/ifcfg-eth0 //添加设备到网桥

| DEVICE=eth0  <br/> TYPE=Ethernet  <br/> BOOTPROTO=static  <br/> IPADDR=0.0.0.0  <br/> ONBOOT=yes  <br/> BRIDGE=br-manager |
|----------------------------------------------------------------------------------------|


重启网卡：

| systemctl restart network |
|---------------------------|


### 业务口网桥

| 增加网桥：  <br/> vi /etc/sysconfig/network-scripts/ifcfg-br-dpdk //创建网桥  <br/> DEVICE=br-dpdk  <br/> TYPE=Bridge  <br/> BOOTPROTO=static  <br/> IPADDR=2.2.3.6  <br/> NETMASK=255.255.255.0  <br/> ONBOOT=yes |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|


vi /etc/sysconfig/network-scripts/ifcfg-eth1 //添加设备到网桥

| DEVICE=eth1  <br/> TYPE=Ethernet  <br/> BOOTPROTO=static  <br/> IPADDR=0.0.0.0  <br/> ONBOOT=yes  <br/> BRIDGE=br-dpdk |
|-------------------------------------------------------------------------------------|


重启网卡：

| /etc/sysconfig/network-scripts/ifdown eth1 //停止网卡  <br/> /etc/sysconfig/network-scripts/ifup eth1 //启动网卡  <br/> /etc/sysconfig/network-scripts/ifup br-dpdk //启动网桥  <br/> ip route add 2.2.1.0/24 via 2.2.3.1 dev br-dpdk //配置网桥路由 |
|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 获取镜像

| yum install -y git git-lfs  <br/> git lfs install  <br/> mkdir -p /export/servers && cd /export/servers  <br/> git lfs clone --depth=1 -b test <https://git.jd.com/dns-anti/dns-vm.git>  <br/> cd dns-vm && git lfs pull  <br/> mkdir -p /export/images/  <br/> cp /export/servers/dns-vm/adns/images/adns-vm-release-20200723\* /export/images/ |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 准备大页内存

| sh /export/servers/dns-vm/adns/tools/install_hugepages.sh //配置大页内存  <br/> reboot //重启服务器  <br/> cat /proc/meminfo\|grep Huge //检查大页内存是否生效 |
|--------------------------------------------------------------------------------------------------------------------------------------------------|


## 优化tap队列

| //将tap网卡默认的txqueue长度由500改为10000,防止丢包  <br/> cat \<\<'EOF'\>/etc/udev/rules.d/71-net-txqueuelen.rules SUBSYSTEM=="net",ACTION=="add",KERNEL=="tap\*",ATTR{tx_queue_len}="10000" EOF |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


## 启动镜像

| virsh define /export/images/adns-vm-release-20200723.xml //创建虚拟机  <br/> virsh list --all //查看虚拟机   <br/> virsh edit adns-vm //编辑网卡  <br/> \<interface type='bridge'\>  <br/> \<mac address='52:54:00:b9:05:4f'/\>  <br/> \<source bridge='br-dpdk'/\>  <br/> \<target dev='tap-dpdk'/\>  <br/> \<model type='virtio'/\>  <br/> \<driver name='vhost' queues='8'/\>  <br/> \<address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/\>  <br/> \</interface\>  <br/> \<interface type='bridge'\>  <br/> \<mac address='52:54:00:e6:bc:3c'/\>  <br/> \<source bridge='br-manager'/\>  <br/> \<target dev='tap-manager'/\>  <br/> \<model type='virtio'/\>  <br/> \<address type='pci' domain='0x0000' bus='0x00' slot='0x09' function='0x0'/\>  <br/> \</interface\> |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


virsh start adns-vm //启动虚拟机

virsh console adns-vm //登录虚拟机

修改网卡配置：

| vi /etc/sysconfig/network-scripts/ifcfg-eth0(业务口：改为不自启动)  <br/> TYPE=Ethernet  <br/> BOOTPROTO=dhcp  <br/> DEFROUTE=yes  <br/> PEERDNS=yes  <br/> PEERROUTES=yes  <br/> IPV4_FAILURE_FATAL=no  <br/> IPV6INIT=yes  <br/> IPV6_AUTOCONF=yes  <br/> IPV6_DEFROUTE=yes  <br/> IPV6_PEERDNS=yes  <br/> IPV6_PEERROUTES=yes  <br/> IPV6_FAILURE_FATAL=no  <br/> NAME=eth0  <br/> UUID=da4f1eab-5423-49a3-b4a5-47f69a6f7b27  <br/> DEVICE=eth0  <br/> ONBOOT=no |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


vi /etc/sysconfig/network-scripts/ifcfg-eth1(管理口：红色部分按需修改)

| TYPE=Ethernet  <br/> BOOTPROTO=static  <br/> IPADDR=10.226.133.77  <br/> NETMASK=255.255.255.224  <br/> GATEWAY=10.226.133.97  <br/> DEFROUTE=yes  <br/> PEERDNS=yes  <br/> PEERROUTES=yes  <br/> IPV4_FAILURE_FATAL=no  <br/> IPV6INIT=yes  <br/> IPV6_AUTOCONF=no  <br/> IPV6ADDR=2001::77/96  <br/> IPV6DEFAULTGW=2001::1/64  <br/> NAME=eth1  <br/> UUID=9aa218da-7502-4820-b2e4-635d45393622  <br/> DEVICE=eth1  <br/> ONBOOT=yes |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


systemctl restart network //重启网卡

修改adns配置：

| vi /export/servers/adns/output/etc/adns.conf //修改adns配置(参考2.8.1节)  <br/> vi /export/servers/adns/output/etc/conf-pull.conf //修改conf-pull配置(参考2.8.2节)  <br/> vi /export/servers/dns-agent/output/conf/config.json //修改dns-agent配置(参考2.8.3节)  <br/> vi /export/servers/keepalived-1.3.5/etc/keepalived.conf //修改keepalived配置(参考2.8.4节)  <br/> 设置conf-pull.py免密登录git服务器：  <br/> ssh-keygen -t rsa (连续三次回车,即在本地生成了公钥和私钥,不设置密码)  <br/> ssh-copy-id -i \~/.ssh/id_rsa.pub 用户名\@git-ip |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


sh /export/servers/dns-agent/output/bin/control restart //重启dns-agent

sh /export/servers/adns/output/bin/control restart //重启adns

systemctl restart keepalived //重启keepalived

ip route add 2.2.1.0/24 via 2.2.3.1 dev vEth0 //配置业务口路由

# **Q&A**

## Q: pdump收不到包

>   A:
>   dpdk收发包队列个数在虚拟机环境必须一致，否则会出现大量丢包，物理机没有限制；

## Q: 双网卡绑定

>   A: 增加物理机bond配置，其他参考4.4.1

| vim /etc/sysconfig/network-scripts/ifcfg-bond0 //添加bond0到网桥(红色部分按需修改)                                                                                                   |
|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| DEVICE=bond0  <br/> NAME=bond0  <br/> TYPE=Bond  <br/> USERCTL=no  <br/> BOOTPROTO=none  <br/> ONBOOT=yes  <br/> BONDING_MASTER=yes  <br/> BONDING_OPTS="mode=1 miimon=100" \# 这里bonding模式是1，根据你的选择而配置  <br/> BRIDGE=adns-br0 |
| vim /etc/sysconfig/network-scripts/ifcfg-em1 //添加em1到bond0(红色部分按需修改)                                                                                                      |
| DEVICE=em1  <br/> USERCTL=no  <br/> ONBOOT=yes  <br/> MASTER=bond0  <br/> SLAVE=yes  <br/> BOOTPROTO=none                                                                                                               |
| vim /etc/sysconfig/network-scripts/ifcfg-em2 //添加em2到bond0(红色部分按需修改)                                                                                                      |
| DEVICE=em2  <br/> USERCTL=no  <br/> ONBOOT=yes  <br/> MASTER=bond0  <br/> TYPE=Ethernet  <br/> SLAVE=yes  <br/> BOOTPROTO=none                                                                                                 |

## Q: 为什么不用docker

>   A: dpdk支持docker有两种方式，如下图：

![dpdk](image/kvm/dpdk.png)

>   Slicing: 需要物理网卡支持SR-IOV，对硬件依然有依赖；

>   Aggregation: 需要在物理机安装支持dpdk的虚拟机交换机，部署复杂；

## Q: tap网卡txdrop

A:
具体原因为虚拟机的cpu被用于处理其他问题，导致没有及时的响应io中断，导致tap网卡的txqueue满，从而丢包；两个方面解决：1.cpu绑定；2.txqueue增大；

![vhost-interactive.png](image/kvm/vhost-interactive.png)

# **参考文档**

-   [KVM/QEMU/qemu-kvm/libvirt
    概念全解](https://blog.csdn.net/Jmilk/article/details/68947277)

-   [KVM虚拟机网络闪断分析](https://www.cnblogs.com/Bozh/p/5484838.html)
